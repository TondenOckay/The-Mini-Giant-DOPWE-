================================================================================
  DOWE MASTER REFERENCE
  Dynamic Object and World Engine - v2.3
  NWN:EE (NWScript) Production Core
  Document Version: 6 (Admin/Security/Debug system finalized)
================================================================================
  PURPOSE OF THIS DOCUMENT
  Upload this file at the start of any future session so the AI assistant
  can immediately understand the full architecture, current state, naming
  conventions, NWScript rules, and how to continue development.
================================================================================

================================================================================
  SECTION 1: WHAT THIS SYSTEM IS
================================================================================

DOWE is a complete NWN:EE server core built on NWScript. It replaces the
conventional approach of writing individual, hardcoded heartbeat scripts for
each server feature. Instead, every feature (called a "package") plugs into
a single data-driven hub via a 2DA file. No core code ever changes when a
new feature is added.

The system has been developed iteratively across multiple sessions with an AI
assistant. All core files are production-hardened.

SETTING: Dark Sun / Athas themed NWN:EE persistent world.

KEY DESIGN GOALS:
  - Zero CPU waste on empty areas (areas with no players run nothing)
  - O(1) data lookups at runtime via module-object local variable cache
  - Fully data-driven: 2DAs are the single source of truth for all settings
  - Extensible without touching core: add a row to a 2DA to add a feature
  - Scalable: designed for 200+ areas, 100+ players, 50+ packages

================================================================================
  SECTION 2: FILE INVENTORY - ALL CORE FILES
================================================================================

LIBRARY FILES (no void main, #included by event scripts):
  core_conductor.nss   - System-wide constants and forward declarations only.
  core_registry.nss    - Object tracking system. Slot-based registry per area.
  core_grid.nss        - Spatial grid for O(1) proximity lookups.
  core_package.nss     - Package hub engine. Reads core_package.2da.
  core_dispatch.nss    - Active-area registry and heartbeat routing.
  core_ai_gps.nss      - GPS proximity sleep/wake/despawn. Library version.
  core_admin.nss       - RBAC security layer. Auth, debug toggle, console cmds.
  ai_hub.nss           - AI sub-system hub library. Reads ai_hub.2da.
  enc_hub_lib.nss      - Encounter sub-system hub library. Reads enc_hub.2da.
  core_registry_hotreload.nss - Functions to reload 2DA caches without restart.

EVENT SCRIPTS (have void main, wired to module/area events):
  core_onload.nss      - Module OnModuleLoad. Boots all systems.
  core_enter.nss       - Area OnEnter. Boots lazy area systems.
  core_mhb.nss         - Module OnModuleHeartbeat. Calls DispatchTick().
  core_heartbeat.nss   - Area OnHeartbeat. Failsafe if module HB stalls.
  core_switch.nss      - Area switchboard. Runs once per HB per active area.
  core_shutdown.nss    - Area OnExit. Tears down area when last PC leaves.
  core_chat.nss        - Module OnPlayerChat. Security gateway + MUD passthrough.
  core_cliententer.nss - Module OnClientEnter. SQL load on connect.
  core_clientleave.nss - Module OnClientLeave. SQL save on disconnect.
  pkg_ai_gps.nss       - GPS package event script. Thin wrapper for GpsTick().
  pkg_ai_hub.nss       - AI hub package event script. Thin wrapper for AiHubTick().
  pkg_enc_hub.nss      - Encounter hub package event script.
  pkg_enc_hub_boot.nss - Encounter hub area boot wrapper.
  pkg_enc_hub_shut.nss - Encounter hub area shutdown wrapper.
  pkg_enc_spawn.nss    - Encounter spawn thin wrapper.
  pkg_enc_radar.nss    - Encounter radar thin wrapper.
  pkg_enc_ai.nss       - Encounter AI thin wrapper.
  pkg_enc_dynamic.nss  - Dynamic random encounter thin wrapper.

ENCOUNTER LIBRARY FILES:
  enc_hub_lib.nss      - Hub manager. Reads enc_hub.2da.
  enc_spawn_lib.nss    - Waypoint-triggered spawn logic.
  enc_shutdown.nss     - Encounter cleanup on area shutdown.
  enc_flag.nss         - Encounter table reader. Reads enc_flag.2da.

2DA FILES:
  core_registry.2da    - Object type definitions (18 types with RF_* flags)
  core_grid.2da        - Grid cell size and update interval settings
  core_ai_gps.2da      - GPS distance defaults (sleep, despawn, owner distances)
  core_package.2da     - Package registry. One row per top-level subsystem.
  core_admin.2da       - Admin accounts (CD keys, passwords, roles)
  ai_hub.2da           - AI sub-system definitions
  enc_hub.2da          - Encounter sub-system definitions
  enc_flag.2da         - Encounter spawn tables by flag/label
  enc_table.2da        - Encounter tier table index
  enc_tier_map.2da     - Terrain label to tier table mapping
  dsrt_common.2da      - Desert common tier mob table
  dsrt_uncommon.2da    - Desert uncommon tier mob table
  dsrt_rare.2da        - Desert rare tier mob table
  enc_mobs_waste.2da   - Wasteland mob table

PERSISTENCE:
  core_sql_persist.nss - SQL save/load for player state.

DELETED/SUPERSEDED:
  dm_hotreload.nss     - Old single-password hotreload. Replaced by core_chat.nss.
                         File kept as no-op shim for backward compatibility.

================================================================================
  SECTION 3: THE NWSCRIPT INCLUDE RULE
================================================================================

NWScript does NOT have a linker. Includes are literal paste operations.

  RULE 1: INCLUDES ARE LITERAL PASTE OPERATIONS.
  RULE 2: FORWARD DECLARATIONS ARE NOT C-STYLE HEADERS.
    A forward declaration only tells the compiler "this exists somewhere below
    me in this file." The IMPLEMENTATION must also be pasted into the same
    compilation unit. If not: ERROR: UNDEFINED IDENTIFIER.
  RULE 3: DUPLICATE INCLUDES = DUPLICATE FUNCTION ERRORS.
    If script A includes B and C, and C also includes B, you get duplicate
    function definition errors. Circular includes are not allowed.

  THE GOLDEN RULE FOR DOWE:
    core_conductor.nss has NO functions. Only const declarations and forward
    declarations. Every library can safely include it without duplication risk.

  COMPILE ORDER (dependencies flow downward):
    core_conductor  (no dependencies)
    core_registry   (includes core_conductor)
    core_grid       (includes core_conductor)
    core_package    (includes core_conductor)
    core_dispatch   (includes core_conductor)
    core_ai_gps     (includes core_conductor, core_registry, core_grid)
    core_admin      (includes core_conductor only)
    ai_hub          (includes core_conductor only)
    enc_hub_lib     (includes core_conductor, core_registry)
    core_chat.nss   (includes core_admin, core_registry, core_package,
                     core_ai_gps, ai_hub, enc_hub_lib)
    core_onload.nss (includes all of the above)

================================================================================
  SECTION 4: TOOLSET WIRING
================================================================================

MODULE EVENTS:
  OnModuleLoad      -> core_onload
  OnModuleHeartbeat -> core_mhb
  OnPlayerChat      -> core_chat          *** IMPORTANT: was dm_hotreload, now core_chat ***
  OnClientEnter     -> core_cliententer
  OnClientLeave     -> core_clientleave

AREA EVENTS (all areas):
  OnEnter           -> core_enter
  OnHeartbeat       -> core_heartbeat
  OnExit            -> core_shutdown

================================================================================
  SECTION 5: BOOT SEQUENCE
================================================================================

core_onload.nss runs these in exact order:

  1. AdminBoot()         - Reads core_admin.2da. Security FIRST.
  2. RegistryBoot()      - Reads core_registry.2da.
  3. PackageBoot()       - Reads core_package.2da.
  4. GridBoot()          - Reads core_grid.2da.
  5. GpsBoot()           - Reads core_ai_gps.2da.
  6. AiHubBoot()         - Reads ai_hub.2da.
  7. EncHubBoot()        - Reads enc_hub.2da.
  8. DispatchBoot()      - Initializes active area counter to 0.
  9. SQLCreateTables()   - Creates player_state, player_variables SQL tables.
  10. PackageCreateTable() - Creates pkg_area_overrides SQL table.
  11. Tick initialized to 1.
  12. All debug flags set to 0 (off).
  13. Verification log entries.

BOOT LOG TO EXPECT:
  [BOOT] Admin security layer online.
  [BOOT] Registry system initialized.
  [BOOT] Package system initialized.
  [BOOT] Grid system initialized.
  [BOOT] GPS proximity system initialized.
  [BOOT] AI hub initialized.
  [BOOT] Encounter hub initialized.
  [BOOT] Dispatch system initialized.
  [BOOT] SQL tables created/verified.
  [BOOT] Registry: 18 object types.
  [BOOT] Packages: N registered.
  [BOOT] Admin: N accounts active.
  [BOOT] AI sub-systems: 4 registered.
  [BOOT] Enc sub-systems: 5 registered.
  DOWE v2.3 - Module Load Complete. System: READY.

IF ADMIN COUNT IS 0:
  core_admin.2da has no active rows. Check:
    - CD_KEY column must be 8-char public CD key (not ********)
    - ACTIVE column must be 1
    - PASSWORD column must not be **** or empty

================================================================================
  SECTION 6: ADMIN / SECURITY SYSTEM
================================================================================

ARCHITECTURE:
  core_admin.2da  - Authority. CD key + password + role level + active flag.
  core_admin.nss  - Library. Reads 2DA, provides AdminBoot/AdminGetRole/
                    AdminHandleCommand. No void main. Included by core_chat.
  core_chat.nss   - Event script. OnPlayerChat handler. Silences /* messages,
                    calls AdminHandleCommand, passes everything else to MUD system.

AUTHENTICATION:
  Dual-factor: CD key (from NWN client) + password (typed inline in chat).
  AdminGetRole(oPC, sPassword) - returns role level 0 (denied) through 10 (master).
  Passwords are never visible: core_chat silences the message BEFORE processing.

ROLES:
  0 = None / denied
  1 = MOD      - Debug toggles, status viewing
  5 = BUILDER  - Reload 2DAs, toggle packages, change intervals
  10 = MASTER  - Force area shutdown, toggle lockdown

ADDING A NEW ADMIN:
  1. Get their CD key from the server log when they connect.
  2. Add a row to core_admin.2da: CD_KEY=theirkey PASSWORD=theirpass ACTIVE=1 ROLE=N
  3. In-game: /*reload admin "masterpassword"
  No server restart needed.

REVOKING ACCESS:
  Set ACTIVE=0 in core_admin.2da, then /*reload admin "masterpassword".

LOCKDOWN MODE:
  /*lockdown "masterpassword"  - Disables ALL commands (even for master role).
  Use for emergencies. Toggle again with same command to lift.
  Even the master cannot execute commands while locked. The only way out is
  a server restart (which re-reads the 2DA with ACTIVE flags).
  Store the lockdown override logic as a server-startup 2DA flag if needed.

COMMAND REFERENCE (all require "password" in double quotes):

  ROLE 1+ (Moderator):
    /*debug on "pass"                   Master debug output: ON
    /*debug off "pass"                  Master debug output: OFF
    /*debug all on "pass"               ALL debug flags: ON
    /*debug all off "pass"              ALL debug flags: OFF
    /*debug [group] on/off "pass"       Toggle a debug group:
       Groups: registry, gps, pkg, switch (=pkg alias), grid, enc, enc_spawn,
               enc_hub, ai, ai_hub, sql, disp, mud, admin
    /*trace [SUFFIX] on/off "pass"      Direct variable setter.
       Sets MG_DEBUG_[SUFFIX] on module. Use for custom per-sub-system flags.
       Example: /*trace ENC_SPAWN on "pass"  sets MG_DEBUG_ENC_SPAWN = 1
    /*status "pass"                     Server overview (tick, areas, packages)
    /*status area "pass"                Package status for your current area
    /*status packages "pass"            All package definitions from 2DA cache

  ROLE 5+ (Builder):
    /*reload "pass"                     Reload ALL 2DA caches
    /*reload admin "pass"               Reload core_admin.2da only
    /*reload registry "pass"            Reload core_registry.2da only
    /*reload gps "pass"                 Reload core_ai_gps.2da only
    /*reload package "pass"             Reload core_package.2da only
    /*pkg off [name] "pass"             Disable a package globally
    /*pkg on [name] "pass"              Enable a package globally
    /*pkg interval [name] [n] "pass"    Change package tick interval globally

  ROLE 10 (Master):
    /*shutdown area "pass"              Force immediate area teardown (your area)
    /*lockdown "pass"                   Toggle console lockdown (emergency use)

HOW TO INTEGRATE WITH YOUR MUD SYSTEM:
  core_chat.nss has a section clearly marked "YOUR MUD CHAT LOGIC HERE".
  Paste your existing OnPlayerChat void main() body into that section.
  Or #include your MUD library and call its handler function there.
  The /* gateway always runs first and returns early - your MUD never sees
  admin commands and never sees passwords.

================================================================================
  SECTION 7: DEBUG SYSTEM
================================================================================

All debug flags are local integers on the module object.
MG_DEBUG must be ON (=1) for any subsystem output to appear.
All subsystem flags are checked after the master gate (zero cost when off).

MASTER GATE:
  MG_DEBUG = "MG_DEBUG"  (string value of the constant)

SUBSYSTEM FLAGS (all also need MG_DEBUG=1):
  MG_DEBUG_VERBOSE  = "MG_DEBUG_VERB"
  MG_DEBUG_REG      = "MG_DEBUG_REG"      Registry add/remove
  MG_DEBUG_ENC      = "MG_DEBUG_ENC"      Encounter system (all enc)
  MG_DEBUG_ENC_SPAWN= "MG_DEBUG_ENCSPWN"  Encounter spawn specifically
  MG_DEBUG_ENC_HUB  = "MG_DEBUG_ENCHUB"   Encounter hub sub-system dispatch
  MG_DEBUG_MUD      = "MG_DEBUG_MUD"      MUD chat
  MG_DEBUG_SQL      = "MG_DEBUG_SQL"      SQL operations
  MG_DEBUG_GPS      = "MG_DEBUG_GPS"      GPS proximity
  MG_DEBUG_PKG      = "MG_DEBUG_PKG"      Package dispatch / core_switch
  MG_DEBUG_GRID     = "MG_DEBUG_GRID"     Grid system
  MG_DEBUG_DISP     = "MG_DEBUG_DISP"     Dispatch active area registry
  MG_DEBUG_AI       = "MG_DEBUG_AI"       AI system (all AI)
  MG_DEBUG_AI_LOGIC = "MG_DEBUG_AILOG"    AI logic archetype
  MG_DEBUG_AI_CAST  = "MG_DEBUG_AICST"    AI caster tactics
  MG_DEBUG_AI_PHYS  = "MG_DEBUG_AIPHY"    AI physics zones
  MG_DEBUG_AI_SURV  = "MG_DEBUG_AISRV"    AI survival system
  MG_DEBUG_AI_HUB   = "MG_DEBUG_AIHUB"    AI hub sub-system dispatch
  MG_DEBUG_ADMIN    = "MG_DEBUG_ADMIN"    Admin console operations

HUB-LEVEL DEBUG VARS (set via DEBUG_VAR column in enc_hub.2da, ai_hub.2da):
  These are STRING VALUES stored in the 2DA, not NWScript constants.
  enc_hub.2da DEBUG_VAR column examples: "MG_DEBUG_ENC_SPAWN", "MG_DEBUG_ENC_AI"
  ai_hub.2da  DEBUG_VAR column examples: "MG_DEBUG_AI_LOGIC", "MG_DEBUG_AI_CAST"
  The hub tick checks MG_DEBUG (master gate) then reads the DEBUG_VAR string
  from its module cache and checks THAT variable. Zero cost in production.

SURGICAL DEBUG PATTERN (per-sub-system, no flood):
  To trace only encounter spawn without seeing all other output:
    /*debug on "pass"                     Enable master gate
    /*trace ENC_SPAWN on "pass"           Enable spawn tracer only
  To trace only AI logic:
    /*debug on "pass"
    /*trace AILOG on "pass"               Sets MG_DEBUG_AILOG = 1
  To kill everything:
    /*debug off "pass"                    Master gate off = all output silenced

================================================================================
  SECTION 8: PACKAGE SYSTEM
================================================================================

core_package.2da is the top-level authority. One row per package.
PackageBoot() caches all rows to module locals at startup.
core_switch dispatches packages every heartbeat for each active area.

COLUMN GUIDE (core_package.2da):
  PACKAGE          Unique ID (lowercase, no spaces)
  ENABLED          1=active globally, 0=disabled
  PRIORITY         Dispatch order (1=first)
  SCRIPT           .nss tick script (no extension)
  BOOT_SCRIPT      .nss run at area boot (or ****)
  SHUTDOWN_SCRIPT  .nss run at area shutdown (or ****)
  INTERVAL         Run every N ticks (1=every tick, 6s per tick)
  MIN_PLAYERS      Min PCs in area to run (0=always)
  PAUSE_THRESHOLD  Pause if load >= this % (0=never pause)
  AREA_OVERRIDE    1=DMs can toggle per-area via SQL
  PHASE            DelayCommand stagger offset in seconds
  DEBUG_VAR        Module-level int name for per-package debug output.
                   core_switch checks this var before logging dispatch.
                   Use **** for packages with no dedicated debug flag.
  AUTH_LEVEL       Minimum admin ROLE to toggle via /*pkg commands.
                   Does NOT gate normal tick dispatch.

CURRENT PACKAGE ROWS (core_package.2da):
  Row 0: ai_gps     - GPS proximity sleep/wake/despawn
  Row 1: ai_hub     - AI sub-system hub
  Row 2: enc_hub    - Encounter sub-system hub (from session 3)
  (additional rows for future packages)

TO ADD A NEW PACKAGE:
  1. Add a row to core_package.2da.
  2. Write the thin wrapper .nss with void main() { YourTick(OBJECT_SELF); }
  3. That's it. No core changes needed.

================================================================================
  SECTION 9: HUB PATTERN (AI HUB / ENCOUNTER HUB)
================================================================================

Some packages are themselves hubs managing sub-systems via their own 2DA.
This is the "hub pattern": a package that reads a second 2DA and dispatches
multiple scripts, instead of just calling one script per tick.

PATTERN:
  core_package.2da row -> pkg_ai_hub.nss -> AiHubTick() -> dispatches ai_hub.2da rows
  core_package.2da row -> pkg_enc_hub.nss -> EncHubTick() -> dispatches enc_hub.2da rows

HUB 2DA COLUMN GUIDE (same columns for both ai_hub.2da and enc_hub.2da):
  SYSTEM       Unique key string
  ENABLED      1/0
  PRIORITY     Execution order within this hub
  SCRIPT       Tick script name
  BOOT_SCRIPT  Area boot script (or ****)
  SHUT_SCRIPT  Area shutdown script (or ****)
  INTERVAL     Run every N ticks (TICKS, not seconds)
  MIN_PLAYERS  Min PCs (0=always)
  PHASE        DelayCommand stagger (float seconds)
  DEBUG_VAR    Module-local int name for this sub-system debug flag.
               Hub tick checks MG_DEBUG then this var before logging.
  AUTH_LEVEL   Min admin role to toggle this sub-system via /*commands.

TO ADD A NEW HUB SUB-SYSTEM:
  1. Add a row to the hub's 2DA (enc_hub.2da or ai_hub.2da).
  2. Write the thin wrapper .nss.
  3. No changes to any other file.

================================================================================
  SECTION 10: ENCOUNTER SYSTEM
================================================================================

(Complete documentation from session 3 - still current)

enc_hub.2da rows:
  Row 0: enc_spawn    - Waypoint-triggered spawning (INTERVAL=1, PHASE=0.2)
  Row 1: enc_ai       - NPC AI state management (INTERVAL=1, PHASE=0.5)
  Row 2: enc_loot     - Loot (PLACEHOLDER - not implemented)
  Row 3: enc_dynamic  - Random open-world encounters (INTERVAL=5, PHASE=1.2)
  Row 4: enc_radar    - Player proximity radar for waypoint triggers (INTERVAL=1, PHASE=0.1)

ENCOUNTER WAYPOINT SETUP (toolset):
  Tag:  Must start with "WP_ENC_" (RF_WP_CREATURE prefix in core_registry.2da)
  Vars: TWP_ROW (int)   - Row in enc_flag.2da for this waypoint
        TWP_2DA (string)- Override 2DA name (default: "enc_flag")
        TTRG_D  (float) - Trigger radius in meters (default: 30.0)
        TRESP_T (int)   - Respawn timer in TICKS

AREA TERRAIN:
  Set ENC_TERRAIN (string local on area object) to: "WASTELAND", "DESERT",
  "CITY", "RUINS" (or add rows to enc_tier_map.2da)

================================================================================
  SECTION 11: BUGS FIXED IN THIS SESSION (v6)
================================================================================

BUG 1 [CRITICAL] core_shutdown_COMPLETE.nss - GetMGDebug() called.
  PROBLEM: Function does not exist anywhere in DOWE.
  FIX: Replaced with GetLocalInt(GetModule(), MG_DEBUG) everywhere.
  FILE: core_shutdown.nss (new canonical version)

BUG 2 [CRITICAL] core_shutdown_COMPLETE.nss - #include "core_const"
  PROBLEM: No such file. The constants file is core_conductor.nss.
  FIX: Changed to #include "core_conductor".
  FILE: core_shutdown.nss

BUG 3 [CRITICAL] core_shutdown_COMPLETE.nss - PackageShutdownArea() called.
  PROBLEM: Function does not exist. The correct name is PackageRunShutdownScripts().
  FIX: Renamed to PackageRunShutdownScripts(oArea).
  FILE: core_shutdown.nss

BUG 4 [CRITICAL] core_shutdown_COMPLETE.nss - DispatchAreaDeactivate() called.
  PROBLEM: Forward-declared in core_conductor but never implemented anywhere.
  The actual deactivation logic is RegistryDeactivateArea() in core_registry.nss.
  DispatchAreaActivate/Deactivate were redundant forward decls from an older design.
  FIX: Replaced with RegistryDeactivateArea(oArea).
  Removed DispatchAreaActivate/Deactivate from core_conductor.nss forward decls.
  FILE: core_shutdown.nss, core_conductor.nss

BUG 5 [CRITICAL] core_shutdown_COMPLETE.nss - GetLocalInt(oMod, PKG_ROW_CNT)
  PROBLEM: PKG_ROW_CNT is not a compile-time constant anywhere. It is a string
  key stored on the module object. This is an UNDEFINED IDENTIFIER compile error.
  FIX: Replaced with GetLocalInt(oMod, "PKG_ROW_CNT").
  FILE: core_shutdown.nss

BUG 6 [CRITICAL] core_onload_COMPLETE.nss - AdminBoot() never called.
  PROBLEM: The security system boots but is never activated at module load.
  No authentication is possible until AdminBoot() caches core_admin.2da.
  FIX: Added AdminBoot() as FIRST call in core_onload.nss.
  FILE: core_onload.nss

BUG 7 [CRITICAL] core_onload_COMPLETE.nss - Hardcoded password.
  PROBLEM: SetLocalString(oMod, "MG_ADMIN_PASSWORD", "change_me_123")
  This old single-password approach bypassed the RBAC 2DA system entirely.
  FIX: Removed. Authentication is now entirely through core_admin.2da + AdminBoot().
  FILE: core_onload.nss

BUG 8 [MODERATE] core_admin.nss - AdminSetDebugAll() missing MG_DEBUG_AI_SURV.
  PROBLEM: core_conductor.nss defines MG_DEBUG_AI_SURV = "MG_DEBUG_AISRV"
  but AdminSetDebugAll() did not include it in the ALL toggle.
  FIX: Added SetLocalInt(oMod, MG_DEBUG_AI_SURV, nVal) to AdminSetDebugAll().
  FILE: core_admin.nss

BUG 9 [MODERATE] core_registry_hotreload.nss - Read after delete.
  PROBLEM: Line 84 read int nFlag = GetLocalInt(oMod, sN + "_FLAG") AFTER
  that variable was deleted on line 66. nFlag was always 0, so the
  reverse-lookup "RG_FLAG_N" entry was never cleaned up.
  FIX: Read nFlag BEFORE the deletion loop begins.
  FILE: core_registry_hotreload.nss

BUG 10 [MODERATE] dm_hotreload.nss - Conflicted with core_admin.nss.
  PROBLEM: Both scripts handled /*reload commands. If both were assigned to
  OnPlayerChat, they would fight. dm_hotreload used a single MG_ADMIN_PASSWORD
  string, not CD-key authenticated RBAC.
  FIX: dm_hotreload.nss converted to a no-op shim with documentation.
  The reload system is now entirely inside core_admin.nss/core_chat.nss.
  FILE: dm_hotreload.nss

BUG 11 [MINOR] core_conductor.nss - DispatchAreaActivate/Deactivate forward decls.
  PROBLEM: These were forward-declared but never implemented (see BUG 4).
  Having forward declarations for non-existent functions misleads developers.
  FIX: Removed. RegistryActivateArea/RegistryDeactivateArea are used instead.
  FILE: core_conductor.nss

================================================================================
  SECTION 12: NEW FILES ADDED IN THIS SESSION (v6)
================================================================================

core_conductor.nss    UPDATED: Removed DispatchAreaActivate/Deactivate,
                               added MG_DEBUG_ENC_SPAWN, MG_DEBUG_ENC_HUB,
                               MG_DEBUG_AI_HUB constants, added EncHubBoot
                               forward declaration.

core_admin.nss        REBUILT: Full RBAC console system.
                               New commands: /*debug switch, /*debug enc_hub,
                               /*debug ai_hub, /*debug enc_spawn, /*trace,
                               /*status area, /*status packages,
                               /*pkg interval [name] [n].
                               Fixed: AdminSetDebugAll now includes AI_SURV.
                               Fixed: /*reload now also calls EncHubBoot().

core_admin.2da        REBUILT: Template with 5 role rows, full documentation
                               comments, LABEL column added.

core_chat.nss         NEW: OnPlayerChat handler. Security gateway first,
                            MUD passthrough below. Single integration point.
                            Includes core_admin, core_registry, core_package,
                            core_ai_gps, ai_hub, enc_hub_lib.

core_onload.nss       REBUILT: Fixed boot sequence. AdminBoot first.
                                Removed hardcoded password. Added GridBoot,
                                AiHubBoot, EncHubBoot, DispatchBoot.

core_shutdown.nss     REBUILT: Fixed all 5 critical bugs listed above.

core_enter.nss        REBUILT: Clean production version. No functional changes,
                                just cleaned up references to correct file names.

core_registry_hotreload.nss  REBUILT: Fixed read-after-delete bug. Uses
                                       correct constant names from core_registry.

pkg_ai_hub.nss        NEW: Thin wrapper for AiHubTick(). Needed because
                           ai_hub.nss is a library with no void main().

dm_hotreload.nss      CONVERTED: No-op shim. Replaced by core_chat.nss.

================================================================================
  SECTION 13: WHAT IS STILL NEEDED / FUTURE WORK
================================================================================

ADMIN SYSTEM - COMPLETE. No further work needed.

ENCOUNTER SYSTEM - REMAINING WORK (unchanged from v5):
  enc_loot system:
    enc_loot_hub_lib.nss  - Loot hub library (NOT YET BUILT)
    enc_loot_hub.2da      - Loot sub-system 2DA (NOT YET BUILT)

  enc_spawn improvements:
    SPWN_T2 column support (minion ResRef separate from main mob)
    Scatter positioning (spawn N mobs in radius, not all at WP origin)
    Respawn logic in periodic tick (not just radar-triggered)

  enc_dynamic improvements:
    TRANS_D tether radius - creature leash to spawn point
    DESPAWN_D cleanup radius

  More terrain tables: city_common/city_uncommon/city_rare, ruins_*

AI SYSTEM - NOT YET BUILT:
  ai_hub.2da and ai_hub.nss exist. Sub-system libraries do NOT yet exist.
  NEEDED:
    ai_lib.nss        - Shared AI utility library
    ai_logic.nss      - Archetype logic
    ai_race.nss       - Race profile library
    ai_class.nss      - Class profile library
    ai_caster.nss     - Caster logic library

  When AI libraries are built:
    Uncomment AI includes in enc_flag.nss (enc_json_v4.nss)
    Replace sys_ai_tactics stub in enc_ai_lib.nss with real logic

PLAYER SURVIVAL SYSTEM - NOT YET BUILT:
  Reads ai_race.2da and ai_class.2da. Same 2DAs as AI system.
  Needs pkg_pc_init and pkg_pc_survive package scripts.

OTHER PLACEHOLDER PACKAGES (rows in core_package.2da, scripts not yet written):
  pkg_livenpc, pkg_corpse, pkg_itemdecay, pkg_gather,
  pkg_crafting, pkg_weather, pkg_ambient, pkg_economy,
  pkg_faction, pkg_persist

================================================================================
  SECTION 14: REGISTRY SYSTEM
================================================================================

KEY TYPES (RF_* flags, must match BITFLAG in core_registry.2da):
  RF_PLAYER       = 1        RF_LIVE_NPC     = 2
  RF_HENCHMAN     = 4        RF_MOUNT        = 8
  RF_PET          = 16       RF_SUMMONED     = 32
  RF_CREATURE     = 64       RF_OBJECT       = 128
  RF_CORPSE       = 256      RF_ITEM         = 512
  RF_GATHER_NODE  = 1024     RF_CRAFT_BOX    = 2048
  RF_WP_NPC       = 4096     RF_WP_CREATURE  = 8192
  RF_WP_WALK      = 16384    RF_TRIGGER      = 32768
  RF_QUEST        = 65536    RF_LOOT_CHEST   = 131072

  RF_ALL_CREATURES = 126  (hardcoded in core_registry.nss - UPDATE IF YOU ADD CREATURES)
  RF_ALL_PLAYERS   = 3    (hardcoded - UPDATE IF YOU ADD PLAYER TYPES)
  RF_ALL_CULLABLE  = 992  (hardcoded - UPDATE IF YOU ADD CULLABLE TYPES)

ITERATION PATTERN:
  string sTok = RegistryToken();
  object oObj = RegistryFirst(oArea, RF_CREATURE, sTok);
  while (GetIsObjectValid(oObj))
  {
      // process oObj
      oObj = RegistryNext(oArea, sTok);
  }

IMPORTANT MAINTENANCE HAZARD:
  RF_ALL_CREATURES/RF_ALL_PLAYERS/RF_ALL_CULLABLE are hardcoded.
  If you add a new IS_CREATURE=1 row to core_registry.2da, update these.

================================================================================
  SECTION 15: GPS SYSTEM
================================================================================

  AI_ST creature local: 0=ACTIVE, 1=SLEEP (set by core_ai_gps)
  All encounter AI scripts check AI_ST==0 before processing creature.
  Creatures beyond DEFAULT_DESP_DIST from all PCs are destroyed automatically.

================================================================================
  SECTION 16: CRITICAL NWSCRIPT RULES (DO NOT VIOLATE)
================================================================================

1. NO GetLocalJson/SetLocalJson. JSON stored as strings via GetLocalString/
   SetLocalString. Parse with JsonParse(), dump with JsonDump().

2. GridGetNeighborCells() RETURNS VOID. Access results via:
   GetLocalInt(GetModule(), "GRD_NC_0") through GetLocalInt(GetModule(), "GRD_NC_8").
   Skip results == -1. Do NOT use return value.

3. RegistryNext(oArea, sToken) - first arg is AREA, not current object.

4. Libraries have no guaranteed OBJECT_SELF. Pass oArea as parameter.

5. INTERVAL in 2DAs is in TICKS (1 tick ~ 6 seconds). NOT seconds.
   Convert: seconds / 6 = ticks.

6. DelayCommand requires VOID functions.
   Create _Void wrappers: void MyFunc_Void(object o) { MyFunc(o); }

7. Variables inside switch/case blocks must be declared before the switch.

8. BITFLAG values in core_registry.2da must be unique powers of 2.
   Next power after 131072 = 262144.

9. Do NOT call Get2DAString at runtime (in tick scripts). Call it only in
   Boot() functions and cache to module locals.

10. Never add packages to core_switch.nss by name.
    Add a row to core_package.2da.

11. Never add enc sub-systems to core_package.2da.
    Add to enc_hub.2da instead. Only enc_hub itself is in core_package.2da.

12. GetPCPublicCDKey(oPC, FALSE) - use FALSE for the public key (second arg).
    TRUE would return the sensitive key (avoid logging/displaying).

================================================================================
  SECTION 17: COMMON MISTAKES (updated)
================================================================================

MISTAKE: Using dm_hotreload.nss on OnPlayerChat.
FIX: Assign core_chat.nss. dm_hotreload.nss is now a no-op shim.

MISTAKE: Calling DispatchAreaActivate() or DispatchAreaDeactivate().
FIX: These were removed. Use RegistryActivateArea() / RegistryDeactivateArea().

MISTAKE: Calling GetMGDebug().
FIX: Function does not exist. Use GetLocalInt(GetModule(), MG_DEBUG).

MISTAKE: Including core_package in enc_hub_lib.nss for JSON functions.
FIX: JSON is built-in. Include only core_conductor and core_registry.

MISTAKE: Getting the AdminBoot() call order wrong in onload.
FIX: AdminBoot() must be called FIRST, before all other boots.

MISTAKE: Using hardcoded MG_ADMIN_PASSWORD for authentication.
FIX: This approach is removed. All auth goes through core_admin.2da + AdminBoot().

MISTAKE: Setting debug flags by hand in core_onload.nss for production.
FIX: All flags default to 0 in core_onload.nss. Use /*debug commands in-game.

MISTAKE: Trying to use /*commands before AdminBoot() caches core_admin.2da.
FIX: AdminBoot() runs at module load. By the time any player connects and
  types a command, the cache is ready.

================================================================================
  END OF DOWE MASTER REFERENCE v6
================================================================================
