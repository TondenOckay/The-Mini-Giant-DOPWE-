================================================================================
DOWE - DYNAMIC OBJECT/WORLD ENGINE
MASTER REFERENCE DOCUMENT v8.0
================================================================================
Sessions: v1-v4 core, v5 enc_hub, v6 enc bugs+2DA review,
          v7 sql rewrite + ghost mode + phase-shift,
          v8 Google Sheets sync + metrics + builder console + RF flag fix
================================================================================

================================================================================
SESSION 8 CHANGELOG
================================================================================

NEW FILES DELIVERED:
  dowe_sheets_sync.py   - Google Sheets -> 2DA sync tool (Python, cross-platform)
  dowe_sheets_sync.ps1  - Google Sheets -> 2DA sync tool (PowerShell, Windows-only)
  core_metrics.nss      - Performance metrics package library
  pkg_metrics.nss       - Metrics tick wrapper
  core_builder.nss      - In-game builder console commands

BUGS FIXED:
  core_ai_gps.nss       - RF_ALL_CREATURES hardcoded const replaced with
                          RegistryFlagCreatures() (computed from 2DA at boot)

EXTERNAL REVIEW RESPONSES:
  Concern 1 (Docs vs Implementation): Acknowledged. Deferred intentionally.
  Concern 2 (Compile-order fragility): Addressed by core_builder //check rf
             and the scaffold commands which output the correct include rules.
  Concern 3 (JSON performance): No change. Concern valid but well-contained.
             The JSON blob is per-area, not per-object. At 50 areas * 15 packages
             that's 750 JSON objects but they're only parsed once per tick, not
             once per object. The caching in core_package.nss ensures the parsed
             json is reused within a tick. Real-world impact: negligible.
  Concern 4 (Hardcoded RF_ALL constants): FIXED.
             core_ai_gps.nss now calls RegistryFlagCreatures() (computed from 2DA).
             core_builder.nss //check rf command warns builders if hardcoded
             consts drift from the computed values.
  Concern 5 (Learning Curve): Addressed by core_builder.nss scaffold commands.
             //scaffold pkg [name] prints the exact steps and file stubs needed.
  Concern 6 (No dependency graph): Acknowledged. Partial mitigation via PHASE
             staggering. REQUIRES column (Idea: medium-term) deferred.

IMPROVEMENTS IMPLEMENTED:
  Easy Win 1: core_metrics.nss - average load, peak creatures, active areas,
              package run counts, rolling 100-sample window. Command: /*metrics
  Easy Win 2: core_builder.nss - //dump registry, //dump packages, //check rf,
              //scaffold pkg, //scaffold sub
  Easy Win 3: RF_ALL_CREATURES fixed to use computed 2DA value
  Medium: Google Sheets sync (both Python and PowerShell versions)

IMPROVEMENTS DEFERRED:
  Easy Win (VERSION row): Useful but low urgency. Design notes below.
  Medium (Web Dashboard): Complex - requires HTTP server outside NWN.
                          SQL override table is already the data source.
                          Recommend a separate Python Flask/FastAPI app.
  Medium (REQUIRES column): Good idea. Design notes below.
  Medium (Per-Area CELL_SIZE): Deferred. Current grid is uniform.
  Long-term items: All deferred as intended.

================================================================================
GOOGLE SHEETS SYNC - COMPLETE GUIDE
================================================================================

PHILOSOPHY:
  NWScript cannot pull from the web. The fix: push from outside.
  A Python or PowerShell script runs on the server host (not inside NWN).
  It downloads your Google Sheet as CSV, converts it to 2DA format,
  drops the file into the NWN override folder, and you hot-reload in-game.
  The game server is never exposed to the internet.

THE TWO TOOLS:
  dowe_sheets_sync.py   - Requires Python 3.8+ and 'pip install requests'
                          Works on Windows, Linux, Mac.
  dowe_sheets_sync.ps1  - PowerShell 5.1+ only (Windows 10/11 built-in)
                          No extra installs needed.

SETUP STEPS:

1. PUBLISH YOUR GOOGLE SHEET AS CSV:
   a. Open Google Sheets
   b. File -> Share -> Publish to web
   c. Select the specific tab (e.g. "enc_dynamic")
   d. Select "Comma-separated values (.csv)"
   e. Click Publish -> Copy the URL
   URL format:
     https://docs.google.com/spreadsheets/d/SHEET_ID/pub?gid=GID&single=true&output=csv

2. CONFIGURE THE SCRIPT:
   Edit the SHEET_MAP in either script:
     "enc_dynamic": "https://docs.google.com/spreadsheets/d/YOUR_ID/pub?gid=..."

   Set OUTPUT_DIR to your NWN override folder:
   Windows: r"C:\NeverwinterNights\NWN\override"
   Linux:   "/opt/nwn/override"

3. TEST WITH DRY RUN:
   Python:     python dowe_sheets_sync.py --dry-run
   PowerShell: .\dowe_sheets_sync.ps1 -DryRun

4. RUN LIVE:
   Python:     python dowe_sheets_sync.py
   PowerShell: .\dowe_sheets_sync.ps1

5. AUTOMATE:
   Linux cron (every 10 minutes):
     */10 * * * * /usr/bin/python3 /opt/dowe/dowe_sheets_sync.py >> /opt/dowe/sync.log 2>&1

   Windows Task Scheduler:
     Action: powershell.exe -ExecutionPolicy Bypass -File "C:\DOWE\dowe_sheets_sync.ps1"
     Trigger: Daily, repeat every 5 minutes for 1 day

6. HOT-RELOAD IN GAME:
   After the script runs, type in-game:
     /*reload "your_password"           - Reloads all 2DA caches
   Or for specific files:
     /*reload package "your_password"   - Just core_package.2da
     (enc_hub and ai_hub reload with the full /*reload command)

GOOGLE SHEET LAYOUT RULES:
  - Row 1: Column headers. Must match the 2DA column names EXACTLY.
    (e.g. "SYSTEM", "ENABLED", "SCRIPT" - case sensitive)
  - Rows 2+: Data rows. The row number (0, 1, 2...) is added automatically.
  - Empty cells become **** automatically.
  - Spaces in cell values become _ automatically (NWN 2DA requirement).
  - Comment rows (starting with //) are ignored.
  - The tool adds the "2DA V2.0" header, comment lines, and last-sync timestamp.

EXAMPLE SHEET COLUMN ORDER FOR core_package.2da:
  PACKAGE | ENABLED | PRIORITY | SCRIPT | BOOT_SCRIPT | SHUTDOWN_SCRIPT |
  INTERVAL | MIN_PLAYERS | PAUSE_THRESHOLD | AREA_OVERRIDE | PHASE |
  DEBUG_VAR | AUTH_LEVEL

EXAMPLE SHEET COLUMN ORDER FOR enc_dynamic.2da:
  LABEL | ACTIVE | CHANCE | INTERVAL | MOB_TABLE | NUM_APP | TRANS_D |
  DESPAWN_D | FADE_IN | AI_LOGIC | LOOT | LOOT_CH | LOOT_MULT

SECURITY NOTE:
  If core_admin.2da is in SHEET_MAP, keep that Google Sheet PRIVATE (not
  published publicly). Anyone with the CSV URL can read your CD keys and
  passwords. Use a separate restricted Sheet for admin credentials, or
  keep core_admin.2da out of the sync system entirely.

CHANGE DETECTION:
  The tool stores an MD5 checksum of each downloaded CSV in sync_state.json.
  If the sheet hasn't changed, no file is written. This means you can run
  the sync every 5 minutes with negligible overhead.

================================================================================
CORE_METRICS.NSS - PERFORMANCE MONITORING
================================================================================

WHAT IT TRACKS:
  All-time since boot:
    - Average CPU load score (%)
    - Peak load score ever seen
    - Peak active area count
    - Peak NPC count in one area
    - Total ticks elapsed
    - Uptime (hours and minutes)

  Rolling window (last 100 samples):
    - Average load per sample window
    - Average active area count
    - Average total entity count (PCs + NPCs)

  Per-area (shown for the area you're standing in):
    - Each package's run count
    - Which packages are currently paused

COMMAND:  /*metrics "password"  (Role 1+ / Moderator)
  - Shows the full report to the DM using it

INSTALLATION:
  1. Add to core_package.2da:
     metrics  1  99  pkg_metrics  ****  ****  10  0  0  0  4.0  MG_DEBUG_METR  1

  2. Add to core_conductor.nss:
     const string MG_DEBUG_METRICS = "MG_DEBUG_METR";  // 14 chars, safe

  3. Add to AdminSetDebugAll() in core_admin.nss:
     SetLocalInt(oMod, MG_DEBUG_METRICS, nVal);

  4. Add to AdminHandleCommand() in core_admin.nss, in the Role 1+ section:
     if (sCmd == "/*metrics" && nRole >= ADM_ROLE_MOD)
     {
         MetricsReport(GetArea(oPC));  // or oPC for area stats
         AdminShowMetrics(oPC);
         return;
     }

  5. Add #include "core_metrics" to core_chat.nss compilation unit.

  6. Add MetricsBoot() to core_onload.nss (after DispatchBoot).

COMPILE ORDER: core_conductor -> core_metrics -> pkg_metrics

================================================================================
CORE_BUILDER.NSS - IN-GAME BUILDER CONSOLE
================================================================================

PURPOSE:
  Lets builders inspect DOWE systems and scaffold new packages from inside
  the game without external tools.

COMMANDS (double-slash prefix):
  //dump registry "pass"        Print all 18 registry type definitions
  //dump packages "pass"        Print all packages with current area state
  //check rf "pass"             Verify RF_ALL_ constants match 2DA values
  //scaffold pkg [name] "pass"  Print step-by-step guide for a new package
  //scaffold sub [name] "pass"  Print guide for a new hub sub-system

SECURITY: Uses the same RBAC auth as admin commands.
  //dump*, //check* = Role 1+ (Moderator)
  //scaffold* = Role 5+ (Builder)

INSTALLATION:
  1. Add #include "core_builder" to core_chat.nss
  2. In core_chat.nss void main(), add ABOVE the /* handler:
       // Builder console (double-slash commands)
       if (GetStringLeft(sMsg, 2) == "//")
       {
           SetPCChatMessage("");
           BuilderHandleCommand(oPC, sMsg);
           return;
       }
  Note: // must be checked BEFORE /* in the chat handler. Both use the
  same authentication so ordering is for cleanliness only.

SCAFFOLD OUTPUT EXAMPLE:
  In-game: //scaffold pkg weather "mypassword"
  Output:
    === SCAFFOLD: New Package 'weather' ===
    STEP 1 - Add to core_package.2da:
      weather  1  99  pkg_weather  ****  ****  1  0  0  1  X.X  MG_DEBUG_WEATHE  5
    STEP 2 - Add to core_conductor.nss:
      const string MG_DEBUG_WEATHE = "MG_DEBUG_WEATHE";
      void WeatherBoot();
    STEP 3 - Create these files:
      weather_lib.nss
      pkg_weather.nss
    STEP 4 - In core_onload.nss: Add WeatherBoot() call.
    STEP 5 - In core_admin.nss AdminSetDebugAll(): Add the new debug flag.

////////////////////////////////////////////////////////////////////////////////
//CHECK RF OUTPUT EXAMPLE:
  === RF FLAG CONSISTENCY CHECK ===
    RF_ALL_PLAYERS:   expected=3   computed=3   OK
    RF_ALL_CREATURES: expected=126 computed=126 OK
    RF_ALL_CULLABLE:  expected=992 computed=992 OK
    All RF flags are consistent with 2DA. No action needed.
////////////////////////////////////////////////////////////////////////////////

================================================================================
RF_ALL_* COMPOSITE FLAG FIX
================================================================================

PROBLEM (Concern 4 from external review):
  core_registry.nss defines three compile-time constants:
    const int RF_ALL_PLAYERS   = 3;    // hardcoded
    const int RF_ALL_CREATURES = 126;  // hardcoded
    const int RF_ALL_CULLABLE  = 992;  // hardcoded

  core_ai_gps.nss used RF_ALL_CREATURES directly in the creature scan loop.
  If a builder adds a new creature type to core_registry.2da, RF_ALL_CREATURES
  stays at 126 and the new type is silently invisible to GPS.

  The system already computes correct values at boot:
    RegistryBoot() calculates RG_COMP_CREATURES by OR-ing all IS_CREATURE=1 flags.
    RegistryFlagCreatures() returns that computed value.

FIX:
  core_ai_gps.nss creature scan loop now calls RegistryFlagCreatures() instead
  of using the hardcoded RF_ALL_CREATURES constant.

  RECOMMENDED: Also update RF_ALL_PLAYERS usage to RegistryFlagPlayers() and
  RF_ALL_CULLABLE to RegistryFlagCullable() in any file that uses them.

ONGOING PROTECTION:
  core_builder.nss //check rf command compares the hardcoded consts against the
  computed values and warns if they diverge. Run this after adding any new
  registry type to verify everything is in sync.

HARDCODED CONSTS STATUS (keep them for compile-time use in boot):
  RF_ALL_PLAYERS   = 3    -- should match RegistryFlagPlayers()
  RF_ALL_CREATURES = 126  -- should match RegistryFlagCreatures()
  RF_ALL_CULLABLE  = 992  -- should match RegistryFlagCullable()
  If you add a new IS_CREATURE=1 type, you must update RF_ALL_CREATURES too.
  The //check rf command will catch this.

================================================================================
DEFERRED IMPROVEMENTS - DESIGN NOTES
================================================================================

VERSION ROW SYSTEM (Easy Win - not implemented yet)
  Design: Add a comment-style row at the top of each 2DA:
  // SCHEMA_VERSION=3
  RegistryBoot/PackageBoot/AiHubBoot read this and store it:
  SetLocalString(oMod, "RG_SCHEMA_VER", "3");
  core_onload validates and logs:
  if (GetLocalString(oMod, "RG_SCHEMA_VER") != EXPECTED_RG_VERSION) error.
  When to use: Add when you make a breaking column change to a 2DA.
  Implementation: ~30 lines, one string read per boot. Trivial cost.

PACKAGE REQUIRES COLUMN (Medium - not implemented yet)
  Design: Add REQUIRES column to core_package.2da.
  Value: comma-separated list of package names this one depends on.
  PackageBoot reads REQUIRES and stores as PKG_[N]_REQUIRES.
  core_switch checks required packages are enabled before dispatching.
  If required package is disabled, skip the dependent one with a warning.
  Example: enc_hub REQUIRES=ai_gps  (enc needs GPS running first)
  Implementation: ~50 lines in core_package.nss + core_switch.nss.

WEB DASHBOARD (Medium - not implemented yet)
  Design: Python Flask app reads from the DOWE SQL database.
  The existing player_state and player_variables tables are the data source.
  Add a metrics_snapshots SQL table populated by core_metrics.nss.
  Dashboard shows: active areas, load history, package states, player count.
  DM controls: toggle packages on/off via SQL (uses AREA_OVERRIDE mechanism).
  Implementation: ~200 lines Python + basic HTML. No NWScript changes needed.

DYNAMIC DIFFICULTY PACKAGE (Long-term)
  A new package in core_package.2da: dyn_difficulty.
  Reads: player count, average party level, active area count.
  Adjusts: enc_dynamic.2da CHANCE values per area (via per-area JSON override).
  Adjusts: ai_hub INTERVAL values for high-load areas (throttle AI on busy areas).
  Implementation: 150-200 lines. Fully data-driven via 2DA tuning tables.

================================================================================
UPDATED FILE REFERENCE - COMPLETE LIST v8
================================================================================

SESSION 8 NEW FILES:
  dowe_sheets_sync.py     External tool. Syncs Google Sheets -> 2DAs.
  dowe_sheets_sync.ps1    External tool (PowerShell). Windows alternative.
  core_metrics.nss        Package library. Performance metrics + DM report.
  pkg_metrics.nss         Thin wrapper for metrics tick.
  core_builder.nss        Builder console library. In-game scaffold + inspect.

SESSION 8 CHANGED FILES:
  core_ai_gps.nss         RF_ALL_CREATURES -> RegistryFlagCreatures() (Concern 4 fix)

ALL CORE FILES (complete inventory):
  core_conductor.nss      Constants + forward declarations
  core_registry.nss       Object registry engine
  core_package.nss        Package lifecycle engine
  core_grid.nss           Spatial grid engine
  core_ai_gps.nss         GPS proximity (ghost mode, phase-shift)
  core_dispatch.nss       Module heartbeat area registry
  core_sql_persist.nss    Native SQL persistence (v7 rewrite)
  core_admin.nss          RBAC security + command handler
  core_switch.nss         Per-area switchboard
  core_enter.nss          Area OnEnter
  core_shutdown.nss       Area OnExit teardown
  core_onload.nss         Module OnModuleLoad
  core_mhb.nss            Module OnModuleHeartbeat wrapper
  core_heartbeat.nss      Area OnHeartbeat failsafe
  core_cliententer.nss    Module OnClientEnter
  core_clientleave.nss    Module OnClientLeave
  core_chat.nss           Module OnPlayerChat (security gateway)
  core_registry_hotreload.nss  Hot-reload for 2DA caches
  core_metrics.nss        Performance monitoring [NEW v8]
  core_builder.nss        Builder console [NEW v8]

  2DAs:
  core_registry.2da  core_package.2da  core_grid.2da  core_ai_gps.2da
  core_admin.2da     ai_hub.2da        enc_hub.2da

  AI SYSTEM: ai_hub.nss, pkg_ai_hub.nss, pkg_ai_gps.nss
  ENC SYSTEM: enc_hub_lib.nss, enc_flag.nss, enc_dynamic_lib.nss,
              enc_radar_lib.nss, enc_ai_lib.nss, enc_json_v4.nss,
              enc_shutdown.nss, enc_table.nss
  PKG WRAPPERS: pkg_enc_hub/boot/shut, pkg_enc_spawn(stub), pkg_enc_ai,
                pkg_enc_dynamic, pkg_enc_radar, pkg_metrics [NEW v8]

================================================================================
WHAT IS STILL MISSING / NOT YET BUILT
================================================================================

enc_spawn_lib.nss     Waypoint-free spawn. pkg_enc_spawn.nss is a STUB.
enc_tier_map.2da      Maps terrain labels to tier 2DA files. CRITICAL - without
                      this, enc_dynamic encounters silently fail in terrain areas.
enc_loot_hub_lib.nss  + enc_loot_hub.2da  Nested loot hub.
puppet_boot.nss       Turns placed NPCs into DOWE puppets for city populations.
VERSION check system  Easy to add. See deferred improvements above.
REQUIRES column       Package dependency enforcement. See deferred above.
Web dashboard         Python Flask app for real-time server monitoring.

================================================================================
COMPILE ORDER - COMPLETE v8 (44 steps)
================================================================================

CORE:
 1.  core_conductor.nss
 2.  core_registry.nss
 3.  core_package.nss
 4.  core_grid.nss
 5.  core_ai_gps.nss
 6.  core_dispatch.nss
 7.  core_sql_persist.nss
 8.  core_admin.nss
 9.  core_metrics.nss          [NEW v8]
10.  core_builder.nss          [NEW v8 - compile AFTER core_admin]
11.  core_switch.nss
12.  core_enter.nss
13.  core_shutdown.nss
14.  core_onload.nss
15.  core_mhb.nss
16.  core_heartbeat.nss
17.  core_cliententer.nss
18.  core_clientleave.nss
19.  core_registry_hotreload.nss

AI SYSTEM:
20.  ai_hub.nss
21.  pkg_ai_hub.nss
22.  pkg_ai_gps.nss

CHAT/ADMIN:
23.  core_chat.nss             [must include core_builder for // commands]

METRICS:
24.  pkg_metrics.nss

ENCOUNTER SYSTEM:
25-38: (same as v7, see DOWE_MASTER_REFERENCE_v7.txt)

AI SUB-PACKAGES:
39-44: (same as v7)

================================================================================
ADMIN CONSOLE COMMANDS - COMPLETE LIST v8
================================================================================

ADMIN (/*) COMMANDS:
  Role 1+: /*debug on/off, /*debug [group] on/off, /*trace [SUFFIX] on/off,
           /*status, /*status area, /*status packages, /*vanish,
           /*metrics  [NEW v8]
  Role 5+: /*reload, /*reload [system], /*pkg on/off/interval
  Role 10+: /*shutdown area, /*lockdown

BUILDER (//) COMMANDS [NEW v8]:
  Role 1+: //dump registry, //dump packages, //check rf
  Role 5+: //scaffold pkg [name], //scaffold sub [name]

================================================================================
END OF MASTER REFERENCE v8
================================================================================
